<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Digital Labour ‚Ä¢ Holiday Agent ‚Äî Dashboard</title>

  <!-- Cyberpunk / terminal fonts & icons -->
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Inter:wght@300;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg-1: #020617;
      --bg-2: #071029;
      --neon-cyan: #00f0ff;
      --neon-magenta: #ff00d0;
      --neon-yellow: #ffd166;
      --glass: rgba(255,255,255,0.04);
      --glass-2: rgba(255,255,255,0.02);
      --panel-radius: 14px;
      --accent: linear-gradient(90deg, rgba(0,240,255,0.12), rgba(255,0,208,0.12));
    }

    html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Share Tech Mono", monospace;background: radial-gradient(1200px 600px at 10% 20%, rgba(0,240,255,0.03), transparent), radial-gradient(900px 400px at 90% 80%, rgba(255,0,208,0.03), transparent), linear-gradient(180deg,var(--bg-1),var(--bg-2)); color:#dbeafe; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }

    /* animated grid / cyber background */
    .grid-bg{
      position:fixed;inset:0;pointer-events:none;opacity:0.18;
      background-image:
        linear-gradient(0deg, rgba(255,255,255,0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
      background-size:60px 60px,60px 60px;
      transform: skewY(-2deg) translateZ(0);
      mix-blend-mode:overlay;
      filter:blur(1px);
    }

    .container{max-width:1200px;margin:28px auto;padding:24px;display:grid;grid-template-columns:1fr 420px;gap:20px;align-items:start;}

    /* terminal panel */
    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border: 1px solid rgba(255,255,255,0.04);
      border-radius:var(--panel-radius);
      padding:18px;
      box-shadow: 0 10px 30px rgba(2,6,23,0.6), 0 0 40px rgba(0,240,255,0.03) inset;
      backdrop-filter: blur(6px) saturate(120%);
    }

    header.brand{
      display:flex;align-items:center;gap:16px;padding:12px 18px;border-radius:12px;margin-bottom:14px;background:linear-gradient(90deg, rgba(0,240,255,0.02), rgba(255,0,208,0.02));
      border:1px solid rgba(255,255,255,0.02);
    }
    .logo{
      width:56px;height:56px;border-radius:10px;display:flex;align-items:center;justify-content:center;
      background: linear-gradient(135deg,var(--neon-cyan),var(--neon-magenta)); color:#001; font-weight:800; font-family:"Share Tech Mono";
      box-shadow: 0 8px 30px rgba(0,240,255,0.08), 0 0 30px rgba(255,0,208,0.06) inset;
      transform: rotate(-6deg);
    }
    header.brand h1{font-size:1.2rem;margin:0;color:#dbeafe}
    header.brand p{margin:0;color:#9fb3da;font-size:0.85rem}

    /* top status */
    .status-row{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:14px}
    .status-pill{display:inline-flex;align-items:center;gap:10px;padding:8px 12px;border-radius:999px;font-weight:700;font-size:0.85rem;background:var(--glass);border:1px solid rgba(255,255,255,0.03)}
    .status-dot{width:10px;height:10px;border-radius:50%;box-shadow:0 0 10px rgba(0,240,255,0.3)}
    .status-running{background:linear-gradient(90deg,#05222b,#09203b);border:1px solid rgba(0,240,255,0.08)}
    .status-paused{background:linear-gradient(90deg,#2a0b12,#2f0b20);border:1px solid rgba(255,0,208,0.06)}

    /* left column content */
    .left-col{display:grid;grid-auto-rows:min-content;gap:16px}
    .cards-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .stat{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:14px;border-radius:10px;text-align:center;border:1px solid rgba(255,255,255,0.02)}
    .stat h3{margin:0;color:#9fb3da;font-size:0.9rem}
    .stat p{margin:6px 0 0 0;font-weight:800;font-size:1.8rem;color:#fff}

    .panel-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .panel-title h2{font-family:"Share Tech Mono";margin:0;color:var(--neon-cyan);letter-spacing:0.8px}
    .panel-sub{color:#9fb3da;font-size:0.85rem}

    /* holiday list */
    .holiday-list{display:grid;gap:10px}
    .holiday-item{
      padding:12px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.014), rgba(255,255,255,0.01));
      border-left:4px solid rgba(0,240,255,0.12);display:flex;justify-content:space-between;align-items:center;font-size:0.95rem;
    }
    .holiday-meta{color:#c1d8ff;font-size:0.92rem}
    .holiday-date{color:var(--neon-magenta);font-weight:700;font-family:"Share Tech Mono"}

    /* right column - terminal emulation */
    .right-col{display:flex;flex-direction:column;gap:12px}
    .terminal{
      background:linear-gradient(180deg, rgba(5,6,20,0.9), rgba(3,3,9,0.7));
      border:1px solid rgba(0,240,255,0.06);
      padding:12px;border-radius:10px;height:420px;overflow:auto;font-family:"Share Tech Mono", monospace;color:#9ee9ff;
      box-shadow: 0 6px 40px rgba(0,240,255,0.03) inset;
    }
    .terminal .line{padding:4px 0;border-bottom:1px dashed rgba(0,240,255,0.04)}
    .terminal .meta{color:#9fb3da;font-size:0.85rem}
    .glow{text-shadow:0 0 18px rgba(0,240,255,0.24)}

    /* buttons */
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .btn{
      background:transparent;border:1px solid rgba(255,255,255,0.06);padding:10px 14px;border-radius:10px;color:#cfeffd;font-weight:700;cursor:pointer;font-size:0.95rem;
      transition:transform 0.12s ease,box-shadow 0.12s ease;
    }
    .btn:hover{transform:translateY(-3px);box-shadow:0 8px 30px rgba(0,240,255,0.06)}
    .btn.primary{background:linear-gradient(90deg,var(--neon-cyan),var(--neon-magenta));color:#041018;border:0}
    .btn.warn{background:linear-gradient(90deg,#ffd166,#ff8ab8);color:#041018;border:0}

    /* logs */
    .log-line{font-family:"Share Tech Mono",monospace;color:#9ee9ff;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.02)}
    .log-time{color:#7fb8c9;margin-right:8px;font-size:0.85rem}
    .log-type.INFO{color:#7fb8c9}
    .log-type.SUCCESS{color:#9be87f'}
    .mini{font-size:0.82rem;color:#9fb3da}

    /* forms - subtle glass */
    .form-row{display:flex;gap:10px;flex-wrap:wrap}
    input[type="text"], textarea, select, input[type="datetime-local"]{
      width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#dbeafe;font-family:Inter;
    }
    textarea{min-height:80px}

    /* small helpers */
    .muted{color:#9fb3da;font-size:0.86rem}
    .right-quiet{font-size:0.85rem;color:#9fb3da}
    .footer-note{font-size:0.82rem;color:#7ea7d6;margin-top:6px}

    /* subtle flicker animation for neon badge */
    @keyframes flicker {
      0% { opacity: 1; }
      50% { opacity: 0.85; }
      100% { opacity: 1; }
    }
    .logo{animation:flicker 3s infinite}
    .neon-pulse{box-shadow:0 0 18px rgba(0,240,255,0.08), 0 0 40px rgba(255,0,208,0.03); animation: glow 3s infinite;}
    @keyframes glow{0%{box-shadow:0 0 6px rgba(0,240,255,0.04)}50%{box-shadow:0 0 22px rgba(0,240,255,0.08)}100%{box-shadow:0 0 6px rgba(0,240,255,0.04)}}

    /* responsive */
    @media (max-width: 980px){
      .container{grid-template-columns:1fr; padding:16px}
      .right-col .terminal{height:360px}
      .cards-grid{grid-template-columns:repeat(2,1fr)}
    }
  </style>
</head>
<body>
  <div class="grid-bg" aria-hidden="true"></div>

  <div class="container">
    <div class="left-col">
      <div class="panel">
        <header class="brand">
          <div class="logo">DL</div>
          <div>
            <h1>Digital Labour ‚Ä¢ Holiday Agent</h1>
            <p class="muted">Automated holiday detection ‚Ä¢ AI announcements ‚Ä¢ Terminal-style dashboard</p>
          </div>
        </header>

        <div class="status-row" id="statusRow">
          <div class="status-pill status-running">
            <span class="status-dot" id="runDot" style="background:linear-gradient(90deg,var(--neon-cyan),var(--neon-magenta))"></span>
            <span id="runText">Running</span>
          </div>
          <div class="status-pill">
            TZ: <strong id="tzLabel" style="margin-left:8px">Loading</strong>
          </div>
          <div class="status-pill">
            Next: <strong id="nextCheck" style="margin-left:8px">--</strong>
          </div>
        </div>

        <div class="cards-grid">
          <div class="stat">
            <h3>Holiday Announcements</h3>
            <p id="holidayCount">0</p>
          </div>
          <div class="stat">
            <h3>Custom Announcements</h3>
            <p id="customCount">0</p>
          </div>
          <div class="stat">
            <h3>Scheduled</h3>
            <p id="scheduledCount">0</p>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-title">
          <h2>üìÖ Today's Holiday</h2>
          <div class="panel-sub mini" id="lastChecked">Checking...</div>
        </div>

        <div id="todayCard" class="holiday-list">
          <div class="holiday-item"><div class="holiday-meta mini">Loading...</div></div>
        </div>

        <div style="height:10px"></div>

        <div class="panel-title">
          <h2>üîÆ Upcoming (30 days)</h2>
          <div class="panel-sub mini">Refreshes from holiday API</div>
        </div>

        <div id="upcoming" class="holiday-list">
          <div class="holiday-item"><div class="holiday-meta mini">Loading...</div></div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-title">
          <h2>‚öôÔ∏è Controls</h2>
          <div class="panel-sub mini">Manual & testing controls</div>
        </div>

        <div class="form-row" style="margin-bottom:10px">
          <select id="holidayWebhook" style="width:100px;">
            <option value="ANNOUNCEMENTS">Announcements</option>
            <option value="HOLIDAYS">Holidays</option>
            <option value="UPDATES">Updates</option>
            <option value="GENERAL">General</option>
          </select>
          <button class="btn primary" onclick="triggerHoliday(this)">üöÄ Test Trigger</button>
          <button class="btn warn" onclick="forceNewYear(this)">üéâ New Year</button>
        </div>

        <div class="panel-sub mini">You can also use an external backup (GitHub Actions/cron) to call /api/trigger/holiday at midnight as extra insurance.</div>
      </div>
    </div>

    <div class="right-col">
      <div class="panel terminal" id="terminal">
        <div class="line meta glow">[agent@digital-labour ~]$ dashboard online ‚Äî listening for midnight checks</div>
        <div id="terminalLines" aria-live="polite"></div>
      </div>

      <div class="panel">
        <div class="panel-title">
          <h2>üìã Activity Log</h2>
          <div class="panel-sub mini">Latest events (click refresh)</div>
        </div>
        <div style="display:flex;gap:8px;margin-bottom:10px">
          <button class="btn" onclick="refreshLogs()">üîÅ Refresh Logs</button>
          <button class="btn" onclick="clearTerminal()">üßπ Clear Terminal</button>
          <div style="flex:1"></div>
          <div class="mini right-quiet">State file: <code>state.json</code></div>
        </div>

        <div id="logContainer" style="max-height:200px;overflow:auto;padding:6px;border-radius:8px;background:var(--glass-2);border:1px solid rgba(255,255,255,0.02)">
          <div class="log-line">Loading logs...</div>
        </div>

        <div class="footer-note">Tip: For guaranteed midnight delivery enable the minute-guard (built-in), run under PM2 or systemd and add an external scheduled trigger as backup.</div>
      </div>
    </div>
  </div>

  <script>
    // Utility: format timestamp
    function fmtTime(ts){
      try { const d = new Date(ts); return d.toLocaleString(); } catch(e){ return ts; }
    }

    // Append a line to terminal area
    function term(msg, type='INFO'){
      const t = document.getElementById('terminalLines');
      const div = document.createElement('div');
      div.className = 'line';
      const time = new Date().toLocaleTimeString();
      div.innerHTML = `<span style="color:#7fb8c9">[${time}]</span> <span style="color:#9ee9ff">${msg}</span>`;
      t.prepend(div);
      // keep terminal height reasonable
      const lines = t.children;
      if(lines.length > 120) t.removeChild(t.lastChild);
    }

    // Load overview data (status, today, upcoming, scheduled)
    async function loadOverview(){
      try {
        const [statusRes, todayRes, upcomingRes, scheduledRes] = await Promise.all([
          fetch('/api/status').then(r=>r.json()),
          fetch('/api/holidays/today').then(r=>r.json()),
          fetch('/api/holidays/upcoming').then(r=>r.json()),
          fetch('/api/announcements/scheduled').then(r=>r.json())
        ]);

        // Status
        const status = statusRes || {};
        document.getElementById('tzLabel').textContent = (status.config && status.config.timezone) || '‚Äî';
        document.getElementById('nextCheck').textContent = (status.nextScheduledCheck || statusRes.config?.timezone ? `Daily at 00:00 (${status.config?.timezone||'TZ'})` : '‚Äî');
        document.getElementById('holidayCount').textContent = status.totalHolidayAnnouncements || 0;
        document.getElementById('customCount').textContent = status.totalCustomAnnouncements || 0;

        // scheduled count from scheduled endpoint
        const scheduled = scheduledRes && scheduledRes.scheduled ? scheduledRes.scheduled.length : 0;
        document.getElementById('scheduledCount').textContent = scheduled;

        // last checked and state
        if(status.state && status.state.lastRunDate){
          document.getElementById('lastChecked').textContent = `Last run (tz): ${status.state.lastRunDate}`;
        } else {
          document.getElementById('lastChecked').textContent = 'Last run: ‚Äî';
        }

        // Today's holiday
        const todayCard = document.getElementById('todayCard');
        todayCard.innerHTML = '';
        if(todayRes && todayRes.holiday){
          const h = todayRes.holiday;
          const html = `<div class="holiday-item"><div>
                        <div style="font-weight:800;color:#fff">${h.name}</div>
                        <div class="holiday-meta">${h.description || h.type || ''}</div>
                      </div>
                      <div class="holiday-date">${h.date}</div></div>`;
          todayCard.innerHTML = html;
        } else {
          todayCard.innerHTML = `<div class="holiday-item"><div class="holiday-meta">No holiday today</div></div>`;
        }

        // Upcoming
        const up = document.getElementById('upcoming');
        up.innerHTML = '';
        if(upcomingRes && upcomingRes.holidays && upcomingRes.holidays.length){
          upcomingRes.holidays.forEach(h=>{
            const el = document.createElement('div');
            el.className = 'holiday-item';
            el.innerHTML = `<div><div style="font-weight:700">${h.name}</div><div class="holiday-meta">${h.description||h.type||''}</div></div><div class="holiday-date">${h.date}</div>`;
            up.appendChild(el);
          });
        } else {
          up.innerHTML = `<div class="holiday-item"><div class="holiday-meta">No upcoming holidays</div></div>`;
        }

        term('Overview refreshed', 'INFO');
      } catch (err) {
        console.error('loadOverview error', err);
        term('Error refreshing overview: ' + err.message, 'ERROR');
      }
    }

    // Trigger holiday check (manual)
    async function triggerHoliday(btn){
      try {
        btn.disabled = true;
        const orig = btn.innerHTML;
        btn.innerHTML = '‚è≥ Triggering...';
        const res = await fetch('/api/trigger/holiday', { method: 'POST' }).then(r=>r.json());
        if(res.success) {
          alert('‚úÖ ' + (res.message || 'Triggered'));
          term('Manual trigger: ' + (res.message || JSON.stringify(res)));
        } else {
          alert('‚ùå ' + (res.message || res.error || 'Failed'));
          term('Manual trigger failed: ' + (res.message || res.error || JSON.stringify(res)), 'ERROR');
        }
        await loadOverview();
      } catch(e){
        alert('‚ùå Error: ' + e.message);
        term('Trigger error: ' + e.message, 'ERROR');
      } finally {
        btn.disabled = false;
        btn.innerHTML = orig;
      }
    }

    // Force New Year test
    async function forceNewYear(btn){
      try {
        btn.disabled = true;
        const orig = btn.innerHTML;
        btn.innerHTML = '‚è≥ Sending...';
        const res = await fetch('/api/test/newyear', { method: 'POST' }).then(r=>r.json());
        if(res.success) {
          alert('‚úÖ New Year announcement sent');
          term('New Year test sent successfully');
        } else {
          alert('‚ùå Failed: ' + (res.error||'Unknown'));
          term('New Year test failed: ' + (res.error||JSON.stringify(res)), 'ERROR');
        }
        await loadOverview();
      } catch(e){
        alert('‚ùå Error: ' + e.message);
        term('New Year test error: ' + e.message, 'ERROR');
      } finally {
        btn.disabled = false;
        btn.innerHTML = orig;
      }
    }

    // Logs
    async function refreshLogs(){
      try {
        const logs = await fetch('/api/logs').then(r=>r.json());
        const container = document.getElementById('logContainer');
        if(!logs || logs.length === 0){
          container.innerHTML = '<div class="log-line">No logs available</div>';
          return;
        }
        container.innerHTML = logs.slice(0,200).map(l=>{
          const t = new Date(l.timestamp).toLocaleString();
          const type = (l.type || 'INFO').toUpperCase();
          return `<div class="log-line"><span class="log-time">[${t}]</span> <span class="log-type ${type}">${type}</span> ‚Äî <span style="color:#cfeffd">${l.message}</span></div>`;
        }).join('');
        term('Logs refreshed', 'INFO');
      } catch(e){
        console.error(e);
        term('Failed to refresh logs: ' + e.message, 'ERROR');
      }
    }

    function clearTerminal(){
      const t = document.getElementById('terminalLines');
      t.innerHTML = '';
      term('Terminal cleared', 'INFO');
    }

    // Auto-refresh overview and logs every 90s to keep UI fresh
    async function bootstrap(){
      await loadOverview();
      await refreshLogs();
      setInterval(loadOverview, 90*1000);
      setInterval(refreshLogs, 90*1000);
    }

    // Init
    window.addEventListener('load', ()=>{
      bootstrap();
      term('Dashboard ready ‚Äî polling status and logs');
    });
  </script>
</body>
</html>
